import requests
import asyncio
import aiohttp
import time

class Whitebit:
    def __init__(self):
        self.headers = {"Content-Type": "application/json"}
        self.urlOrderbooks = f"https://whitebit.com/api/v2/public/depth/"
        self.urlMarkets = f"https://whitebit.com/api/v1/public/markets"
        self.markets = {}
        self.fees = {}
        self.requestLimit = 1281

    def get_markets(self):
        markets = requests.get(url=self.urlMarkets, headers=self.headers).json()
        for market in markets['result']:
            if '_USD' in market['name']:
                coin = market['name'].split('_USD')[0]
                self.markets.update({coin: market['name']})
        return (self.markets)
        # return(markets)

    def get_coin_fee(self, symbol):
        fees = requests.get(url=self.urlMarkets, headers=self.headers).json()
        for fee in fees['result']:
            if symbol == fee['name']:
                self.fees.update({symbol: {"Maker": fee['makerFee'], "Taker": fee['takerFee']}})
        return self.fees

    async def get_orderbook(self, symbol):
        async with aiohttp.ClientSession() as session:  # менеджер отправления запросов
            async with session.get(self.urlOrderbooks + symbol) as response:
                ob = await response.json()
                # print(ob)
        return {"top_ask": ob['result']["asks"][0][0], "ask_vol": ob['result']["asks"][0][1],
                "top_bid": ob['result']["bids"][0][0], "bid_vol": ob['result']["bids"][0][1],
                "ts_exchange": 0}

async def main():
    orderbook = Whitebit()
    # result = await orderbook.get_orderbook('BTC_USDT')
    # print(result)
    while True:
        t0 = time.time()
        result = asyncio.create_task(orderbook.get_orderbook('BTC_USDT'))
        await result
        print(time.time() - t0)

if __name__ == "__main__":
    markets = Whitebit()
    print(markets.get_markets())
    print(markets.get_coin_fee('BTC_USDT'))
    asyncio.run(main())

# {'success': True, 'message': None, 'result': {'lastUpdateTimestamp': '2023-08-10T05:17:38Z', 'asks': [['29517.36', '0.101784'], ['29518.55', '0.431214'], ['29519.73', '1.926447'], ['29520.05', '0.25'], ['29520.91', '1.351357'], ['29522.09', '0.064634'], ['29523.27', '3.110511'], ['29524.45', '0.725355'], ['29525.64', '2.627194'], ['29526.82', '5.365276'], ['29528', '4.197777'], ['29529.18', '4.316372'], ['29530.36', '1.568038'], ['29531.54', '3.501987'], ['29532.73', '3.521203'], ['29533.91', '8.68241'], ['29535.09', '6.014875'], ['29535.1', '0.0107'], ['29536.27', '8.015473'], ['29537.45', '5.802377'], ['29538.64', '8.59926'], ['29539.82', '8.478825'], ['29541', '6.320013'], ['29542.18', '8.88174'], ['29543.37', '8.899762'], ['29544.55', '7.097288'], ['29545.73', '7.139447'], ['29546.63', '1.5017'], ['29546.64', '0.02342'], ['29546.7', '1.01738'], ['29546.71', '0.03089'], ['29546.91', '8.579481'], ['29546.95', '0.03537'], ['29547', '1.0006'], ['29547.24', '2.03305'], ['29547.29', '0.02366'], ['29547.42', '0.00471'], ['29547.52', '0.06931'], ['29547.59', '0.0317'], ['29547.6', '3.36607'], ['29547.76', '0.40504'], ['29547.89', '5.10538'], ['29547.9', '8.50885'], ['29547.95', '0.02269'], ['29548', '0.33849'], ['29548.1', '10.370637'], ['29548.33', '0.82667'], ['29548.34', '1.37769'], ['29548.39', '0.00784'], ['29548.41', '0.0694'], ['29548.47', '0.20485'], ['29548.48', '0.34043'], ['29548.49', '0.02817'], ['29548.55', '0.07071'], ['29548.72', '0.06279'], ['29548.76', '0.07173'], ['29548.97', '0.25'], ['29549.03', '0.057'], ['29549.28', '10.252291'], ['29549.3', '0.0317'], ['29549.33', '0.17594'], ['29549.37', '0.2017'], ['29549.38', '0.0309'], ['29549.83', '8.90378'], ['29549.94', '2.0316'], ['29549.97', '0.25'], ['29550', '21.34465'], ['29550.18', '3.38784'], ['29550.19', '0.0317'], ['29550.2', '0.03393'], ['29550.26', '1.15373'], ['29550.27', '0.44095'], ['29550.46', '10.388497'], ['29550.63', '0.11154'], ['29550.97', '0.25'], ['29551.02', '0.25383'], ['29551.15', '0.16434'], ['29551.16', '0.61024'], ['29551.64', '8.788044'], ['29551.95', '0.20317'], ['29551.97', '0.03555'], ['29552', '0.33853'], ['29552.05', '0.0609'], ['29552.16', '0.00424'], ['29552.77', '0.22313'], ['29552.78', '0.37175'], ['29552.83', '9.530785'], ['29552.86', '0.05248'], ['29552.87', '0.17594'], ['29552.88', '0.00737'], ['29552.94', '0.08715'], ['29553.53', '0.03'], ['29553.75', '0.15316'], ['29553.82', '0.1399'], ['29553.83', '0.33956'], ['29554.01', '9.443217'], ['29554.09', '0.15604'], ['29554.3', '0.33951'], ['29554.35', '0.03445'], ['29554.45', '0.0064']], 'bids': [['29516.18', '0.628979'], ['29515', '1.15401'], ['29513.82', '2.90724'], ['29512.64', '0.735611'], ['29511.46', '3.841102'], ['29510.28', '4.978703'], ['29509.1', '1.814335'], ['29507.91', '4.602993'], ['29506.73', '5.633213'], ['29505.55', '2.158024'], ['29504.37', '7.654823'], ['29503.19', '7.293246'], ['29502.01', '3.718564'], ['29500.83', '8.378923'], ['29500', '0.000445'], ['29499.65', '6.941568'], ['29498.47', '12.050191'], ['29497.29', '5.683706'], ['29496.11', '15.191313'], ['29494.93', '7.894488'], ['29493.75', '8.119467'], ['29492.57', '11.242195'], ['29491.38', '13.850957'], ['29490.2', '16.484902'], ['29489.02', '5.855307'], ['29487.84', '21.433361'], ['29487.57', '0.06037'], ['29487.56', '0.00936'], ['29487.5', '0.50964'], ['29487.46', '0.01686'], ['29487.44', '0.63175'], ['29487.35', '0.06953'], ['29487.02', '1.05289'], ['29486.8', '0.50044'], ['29486.75', '0.01516'], ['29486.66', '13.419104'], ['29486.62', '0.04647'], ['29486.6', '0.03537'], ['29486.48', '0.01701'], ['29486.43', '0.06774'], ['29486.42', '0.0155'], ['29486.35', '0.01563'], ['29486.08', '0.265'], ['29485.92', '0.01042'], ['29485.91', '0.00562'], ['29485.59', '0.1057'], ['29485.58', '0.1761'], ['29485.48', '10.836843'], ['29485.29', '0.72452'], ['29485.26', '0.1791'], ['29485.25', '0.01148'], ['29485.14', '0.03389'], ['29485', '0.01999'], ['29484.86', '0.04281'], ['29484.63', '0.00478'], ['29484.59', '0.0109'], ['29484.51', '0.00467'], ['29484.47', '0.02507'], ['29484.34', '0.20521'], ['29484.33', '0.33578'], ['29484.3', '7.668897'], ['29484.07', '0.01128'], ['29484', '0.34189'], ['29483.87', '0.06974'], ['29483.57', '0.32488'], ['29483.28', '0.15602'], ['29483.12', '17.452506'], ['29482.83', '0.16766'], ['29482.52', '0.01673'], ['29482.51', '0.40652'], ['29482.5', '0.50315'], ['29482.38', '0.0068'], ['29482.34', '0.01149'], ['29482.33', '0.1665'], ['29482.09', '1.69112'], ['29482.04', '0.1761'], ['29482', '0.50144'], ['29481.95', '0.00766'], ['29481.94', '12.448739'], ['29481.87', '0.0171'], ['29481.38', '0.3125'], ['29481.37', '0.01634'], ['29481.33', '0.32436'], ['29481.29', '0.28802'], ['29481.19', '0.32448'], ['29481.01', '0.01191'], ['29481', '0.01569'], ['29480.99', '0.05477'], ['29480.94', '0.01625'], ['29480.76', '30.283528'], ['29480.5', '0.01'], ['29480.19', '0.01677'], ['29480.18', '0.00665'], ['29480.1', '0.50114'], ['29480', '2.74341'], ['29479.84', '0.01742'], ['29479.71', '0.12784'], ['29479.58', '17.971087'], ['29479.56', '0.01523'], ['29479.45', '0.01556']]}}
